---
title: "03_DESeq_pit"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(DESeq2)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(kableExtra)
library(viridis)

# load custom functions  
source("../R/functions.R")  

knitr::opts_chunk$set(fig.path = '../figures/pit/',cache=TRUE)
```

# Females only

```{r read} 
# import "colData" which contains sample information and "countData" which contains read counts
colData <- read.csv("../results/00_colData_characterization.csv", header = T, row.names = 1)
countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)  
geneinfo <- read.csv("../results/00_geneinfo.csv", row.names = 1)
```

```{r factors} 
colData$treatment <- factor(colData$treatment, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))  
```

```{r filter} 
colData <- colData %>%
  dplyr::filter(grepl('pituitary', tissue)) %>%
  dplyr::filter(sex == "female") %>%
  droplevels()
row.names(colData) <- colData$V1

# print sample sizes
colData %>% select(group, tissue)  %>%  summary()

savecols <- as.character(colData$V1) 
savecols <- as.vector(savecols) 
countData <- countData %>% dplyr::select(one_of(savecols)) 

# check that row and col lenghts are equal
ncol(countData) == nrow(colData)     
```



```{r deseq2}  
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ treatment ) 
dds <- dds[ rowSums(counts(dds)) > 2, ] ## pre-filter genes 
dds <- DESeq(dds) # Differential expression analysis
vsd <- vst(dds, blind=FALSE) # variance stabilized   
```


```{r resloop} 
#create list of groups
a <- levels(colData$treatment)
b <- levels(colData$treatment)

# slim for testing
#a <- c("n9", "bldg" , "lay" )
#b <- c("n9", "bldg" , "lay" )

# comapre all contrasts, save to datafrmes
dat=data.frame()
for (i in a){
  for (j in b){
    if (i != j) {
      k <- paste(i,j, sep = "") #assigns usique rownames
      dat[k,1]<-i               
      dat[k,2]<-j
      dat[k,3]<- numDEGs(i,j) #caluculates number of DEGs
    }
  }
}

head(dat)  
```

```{r restable} 
# widen data to create table of degs
rownames(dat) <- NULL #remove row names
data_wide <- spread(dat, V2, V3)
data_wide
kable(data_wide) 

dat$V1 <- factor(dat$V1, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))
dat$V2 <- factor(dat$V2, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))

dat %>%
  filter(V1 != "control", V2 != "control")  %>%
  ggplot( aes(V1, V2)) +
    geom_tile(aes(fill = V3)) +
    scale_fill_viridis(na.value="#FFFFFF00", 
                     limits = c(0, 5025),
                     breaks = c(0, 1000, 2000, 3000, 4000, 5000)) + 
    xlab(" ") + ylab("Timepoint") +
    labs(fill = "# of DEGs") 
```

```{r PCA, message=FALSE, warning=FALSE} 
# create the dataframe using my function pcadataframe
pcadata <- pcadataframe(vsd, intgroup=c("treatment"), returnData=TRUE)
percentVar <- round(100 * attr(pcadata, "percentVar"))
percentVar

ggplot(pcadata, aes(PC1, PC2,color = treatment)) + 
  geom_point(size = 2, alpha = 1) +
  stat_ellipse(type = "t") +
  xlab(paste0("PC1: ", percentVar[1],"% variance")) +
  ylab(paste0("PC2: ", percentVar[2],"% variance")) +
  theme_cowplot(font_size = 8, line_size = 0.25) 

summary(aov(PC1 ~ treatment, data=pcadata)) 
TukeyHSD(aov(PC1 ~ treatment, data=pcadata), which = "treatment") 

summary(aov(PC2 ~ treatment, data=pcadata)) 
TukeyHSD(aov(PC2 ~ treatment, data=pcadata), which = "treatment") 

ggplot(pcadata, aes(PC3, PC4,color = treatment)) + 
  geom_point(size = 2, alpha = 1) +
  stat_ellipse(type = "t") +
  xlab(paste0("PC3: ", percentVar[3],"% variance")) +
  ylab(paste0("PC4: ", percentVar[4],"% variance")) +
  theme_cowplot(font_size = 8, line_size = 0.25) 

summary(aov(PC3 ~ treatment, data=pcadata)) 

summary(aov(PC4 ~ treatment, data=pcadata)) 

summary(aov(PC5 ~ treatment, data=pcadata)) 

summary(aov(PC6 ~ treatment, data=pcadata))   
```

Heatmaps

```{r heatmap} 
# see http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#heatmap-of-the-count-matrix
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- NULL
colnames(sampleDistMatrix) <- colData$treatment
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors,
         fontsize = 6)  
```

# Males only

```{r readMale}
# import "colData" which contains sample information and "countData" which contains read counts
colData <- read.csv("../results/00_colData_characterization.csv", header = T, row.names = 1)
countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)
geneinfo <- read.csv("../results/00_geneinfo.csv", row.names = 1)  
```

```{r factorsMale}
colData$treatment <- factor(colData$treatment, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))
```

```{r filterMale}
colData <- colData %>%
  dplyr::filter(grepl('pituitary', tissue)) %>%
  dplyr::filter(sex == "male") %>%
  droplevels()
row.names(colData) <- colData$V1

# print sample sizes
colData %>% select(group, tissue)  %>%  summary()

savecols <- as.character(colData$V1) 
savecols <- as.vector(savecols) 
countData <- countData %>% dplyr::select(one_of(savecols)) 

# check that row and col lenghts are equal
ncol(countData) == nrow(colData) 
```

```{r deseq2male} 
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ treatment )
dds <- dds[ rowSums(counts(dds)) > 2, ] ## pre-filter genes 
dds <- DESeq(dds) # Differential expression analysis
vsd <- vst(dds, blind=FALSE) # variance stabilized   
```

```{r resloopMale} 
#create list of groups
a <- levels(colData$treatment)
b <- levels(colData$treatment)

# slim for testing
#a <- c("n9", "bldg" , "lay" )
#b <- c("n9", "bldg" , "lay" )

# comapre all contrasts, save to datafrmes
dat=data.frame()
for (i in a){
  for (j in b){
    if (i != j) {
      k <- paste(i,j, sep = "") #assigns usique rownames
      dat[k,1]<-i               
      dat[k,2]<-j
      dat[k,3]<- numDEGs(i,j) #caluculates number of DEGs
    }
  }
}  

head(dat)
```

```{r restableMale} 
# widen data to create table of degs
rownames(dat) <- NULL #remove row names
data_wide <- spread(dat, V2, V3)
data_wide
kable(data_wide) 

dat$V1 <- factor(dat$V1, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))
dat$V2 <- factor(dat$V2, levels = 
                              c("control", "bldg", "lay", "inc.d3", "inc.d9", 
                                "inc.d17", "hatch", "n5", "n9"))


dat %>%
  filter(V1 != "control", V2 != "control")  %>%
  ggplot( aes(V1, V2)) +
    geom_tile(aes(fill = V3)) +
    scale_fill_viridis(na.value="#FFFFFF00", 
                     limits = c(0, 5025),
                     breaks = c(0, 1000, 2000, 3000, 4000, 5000)) + 
    xlab(" ") + ylab("Timepoint") +
    labs(fill = "# of DEGs")
```

```{r PCAmale, message=FALSE, warning=FALSE}
# create the dataframe using my function pcadataframe
pcadata <- pcadataframe(vsd, intgroup=c("treatment"), returnData=TRUE)
percentVar <- round(100 * attr(pcadata, "percentVar"))
percentVar

ggplot(pcadata, aes(PC1, PC2,color = treatment)) + 
  geom_point(size = 2, alpha = 1) +
  stat_ellipse(type = "t") +
  xlab(paste0("PC1: ", percentVar[1],"% variance")) +
  ylab(paste0("PC2: ", percentVar[2],"% variance")) +
  theme_cowplot(font_size = 8, line_size = 0.25) 

summary(aov(PC1 ~ treatment, data=pcadata)) 
TukeyHSD(aov(PC1 ~ treatment, data=pcadata), which = "treatment") 

summary(aov(PC2 ~ treatment, data=pcadata)) 
TukeyHSD(aov(PC2 ~ treatment, data=pcadata), which = "treatment") 

ggplot(pcadata, aes(PC3, PC4,color = treatment)) + 
  geom_point(size = 2, alpha = 1) +
  stat_ellipse(type = "t") +
  xlab(paste0("PC3: ", percentVar[3],"% variance")) +
  ylab(paste0("PC4: ", percentVar[4],"% variance")) +
  theme_cowplot(font_size = 8, line_size = 0.25) 

summary(aov(PC3 ~ treatment, data=pcadata)) 

summary(aov(PC4 ~ treatment, data=pcadata)) 

summary(aov(PC5 ~ treatment, data=pcadata)) 

summary(aov(PC6 ~ treatment, data=pcadata))   
```

Heatmaps

```{r heatmapMale} 
# see http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#heatmap-of-the-count-matrix
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- NULL
colnames(sampleDistMatrix) <- colData$treatment
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors,
         fontsize = 6)  
```