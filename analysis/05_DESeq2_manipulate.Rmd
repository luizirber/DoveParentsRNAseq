---
title: "05_DESeq_manipulation"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(DESeq2)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(kableExtra)
library(viridis)
library(edgeR)

# load custom functions  
source("../R/functions.R") 

knitr::opts_chunk$set(fig.path = '../figures/manipulation/', cache = TRUE)
```

## Manipulation data

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
m.colData <- read.csv("../metadata/00_colData_manipluation.csv", header = T, row.names = 1)
m.countData <- read.csv("../results/00_countData_manipluation.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
m.colData$treatment <- factor(m.colData$treatment, levels = 
                              c("m.inc.d3",  "m.inc.d8",
                                "m.inc.d9", "m.inc.d17",
                                "prolong", "extend", "m.n2"))

m.colData$sextissue <- as.factor(paste(m.colData$sex, m.colData$tissue, sep = "_"))

m.colData$outcome <- ifelse(grepl("d3|d9|d17", m.colData$treatment), "end inc", 
                     ifelse(grepl("d8|n2", m.colData$treatment),"end hatch",
                     ifelse(grepl("prolong", m.colData$treatment),"prolong inc",
                     ifelse(grepl("extend", m.colData$treatment),"delay hatch", NA))))

m.colData$outcome <- factor(m.colData$outcome, levels = 
                              c("end inc",  "end hatch",
                                "prolong inc", "delay hatch"))
summary(m.colData[c(7,3,4,5,8,9)])
```

## Run DESeq on all subsets of the data

```{r dds}
## subset for test 
#m.colData <- m.colData %>%
#  filter(sextissue == "male_hypothalamus") %>%
# droplevels()

levels(m.colData$sextissue)

for (eachgroup in levels(m.colData$sextissue)){
  
  print(eachgroup)
  dds <- subsetDESeq(eachgroup)
  
  dfname <- paste("dds", eachgroup, sep = "")
  assign(paste("dds", eachgroup, sep = ""), dds)

  return(dfname)
}   

```

## Create variance stabilized data

```{r vsd}

mydds <- list(ddsmale_hypothalamus) # for testing only
#mydds <- list(ddsfemale_hypothalamus, ddsfemale_pituitary, ddsfemale_gondad,
#              ddsmale_hypothalamus, ddsmale_pituitary, ddsmale_gondad)

for (eachdds in mydds){
  
  vsd <- vst(eachdds, blind=FALSE) # variance stabilized 
  
  vdsname <- paste("vsd", eachgroup, sep = "")
  assign(paste("vsd", eachgroup, sep = ""), vsd)
  return(vdsname)
}

```

## Calculate and plot total DEGs

```{r totalDEGs}

#create list of groups
a <- levels(colData$treatment)
b <- levels(colData$treatment)

for (eachdds in mydds){

  # comapre all contrasts, save to datafrmes
  totalDEGS=data.frame()
  for (i in a){
    for (j in b){
      if (i != j) {
        k <- paste(i,j, sep = ".") #assigns usique rownames
        print(k)
        totalDEGS[k,1]<-i               
        totalDEGS[k,2]<-j
        totalDEGS[k,3]<- numDEGs(i,j) #caluculates number of DEGs
      }
    }
        b <- b[-1]  # drop 1st element of second string to not recalculate DEGs
  }


  head(totalDEGS)

  # widen data to create table of degs
  rownames(totalDEGS) <- NULL #remove row names
  totalDEGS_wide <- spread(totalDEGS, V2, V3)
  print(totalDEGS_wide) 

  totalDEGS$V1 <- factor(totalDEGS$V1, levels = 
                              c("m.inc.d3",  "m.inc.d8",
                                "m.inc.d9", "m.inc.d17",
                                "prolong", "extend", "m.n2"))
  totalDEGS$V2 <- factor(totalDEGS$V2, levels = 
                              c("m.inc.d3",  "m.inc.d8",
                                "m.inc.d9", "m.inc.d17",
                                "prolong", "extend", "m.n2"))

  allcontrasts <- totalDEGS %>%
    ggplot( aes(V1, V2)) +
      geom_tile(aes(fill = V3)) +
      scale_fill_viridis(na.value="#440154", 
                      limits = c(0, 3000),
                      breaks = c(0, 1000, 2000, 3000)) + 
      xlab(" ") + ylab("Timepoint") +
      labs(fill = "# of DEGs",
          subtitle = "eachgroup")
  plot(allcontrasts)
}
```


# create the dataframe using my function pcadataframe
pcadata <- pcadataframe(vsd, intgroup=c("treatment"), returnData=TRUE)
percentVar <- round(100 * attr(pcadata, "percentVar"))
print(percentVar)


pca1 <- ggplot(pcadata, aes(treatment, PC1,color = treatment)) + 
  geom_boxplot() +
  ylab(paste0("PC1: ", percentVar[1],"% variance")) +
  xlab(NULL) +
  theme_cowplot(font_size = 8, line_size = 0.25) +
  labs(subtitle = eachgroup) +
  theme(legend.position = "none")


pca2 <- ggplot(pcadata, aes(treatment, PC2,color = treatment)) + 
  geom_boxplot() +
  ylab(paste0("PC2: ", percentVar[2],"% variance")) +
  xlab(NULL) +
  theme_cowplot(font_size = 8, line_size = 0.25) +
  labs(subtitle = eachgroup) +
  theme(legend.position = "none")

plot_grid(pca1, pca2)



print(summary(aov(PC1 ~ treatment, data=pcadata)))
print(TukeyHSD(aov(PC1 ~ treatment, data=pcadata), which = "treatment"))

print(summary(aov(PC2 ~ treatment, data=pcadata))) 
print(summary(aov(PC3 ~ treatment, data=pcadata))) 
print(summary(aov(PC4 ~ treatment, data=pcadata))) 


## heamap with minimum pvalue

# make dataframe counts
DEGs <- assay(vsd)
DEGs <- as.data.frame(DEGs)

# add pvalues

for (i in a){
  for (j in b){
    if (i != j) {
      k <- paste(i,j, sep = " vs ")
      print(k)
      results <- returnpadj(i,j)
      DEGs <- cbind(DEGs,results)
    }
  }
}

DEGsmatrix <- DEGs
DEGsmatrix <- as.matrix(DEGs)
padjmin <- rowMins(DEGsmatrix, na.rm = T) 
padjmin <- as.data.frame(padjmin)

sigDEGs <- cbind(DEGs,padjmin)

sigDEGs <- sigDEGs %>% arrange(padjmin)
sigDEGs <- head(sigDEGs,500)
sigDEGs <- as.data.frame(sigDEGs)
rownames(sigDEGs) <- sigDEGs$rownames
drop.cols <-colnames(sigDEGs[,grep("padj|pval|pmin|rownames", colnames(sigDEGs))])
sigDEGs <- sigDEGs %>% dplyr::select(-one_of(drop.cols))
sigDEGs <- as.matrix(sigDEGs)
sigDEGs <- sigDEGs - rowMeans(sigDEGs)

paletteLength <- 30
myBreaks <- c(seq(min(sigDEGs), 0, length.out=ceiling(paletteLength/2) + 1), 
                seq(max(sigDEGs)/paletteLength, max(sigDEGs), length.out=floor(paletteLength/2)))

anndf <- m.colData %>% dplyr::select(treatment)
rownames(anndf) <- m.colData$V1

sigDEGs <- as.matrix(sigDEGs) 
pheatmap(sigDEGs, show_rownames = F, show_colnames = F,
         color = viridis(30),
         breaks=myBreaks,
         annotation_col=anndf,
         main = eachgroup)

pheatmap(sigDEGs, kmeans_k = 5,
         show_rownames = F, show_colnames = F,
         color = viridis(30),
         breaks=myBreaks,
         annotation_col=anndf,
         main = eachgroup)

## candidate genes
names(geneinfo)
names(geneinfo)[4] <- "rownames"
DEGs$rownames <- row.names(DEGs)

# make dataframe with geneids and names and counts
# how to gather: https://tidyr.tidyverse.org/reference/gather.html

candidates <- full_join(geneinfo, DEGs)
drop.cols <-colnames(candidates[,grep("padj|pval|pmin", colnames(candidates))])
candidates <- candidates %>% dplyr::select(-one_of(drop.cols))
candidates <- candidates %>%
  filter(Name %in% c( #"JUN", "JUND", "EGR",  "AVP", "AVPR1A", "AVPR1B", "AVPR2", "OXT",  
                     "AR", "CYP19A1", "ESR1", "ESR2", "FSHR",
                     "GHRL", "GAL", "NPVF", "GNRH1", "LHCGR",
                     "PGR", "PRL", "PRLR", "VIP", "VIPR1")) 
row.names(candidates) <- candidates$Name
candidates <- candidates %>% select(-row.names, -rownames, -Name, -geneid)
candidates <- candidates %>% drop_na()
candidates <- as.data.frame(t(candidates))
candidates$RNAseqID <- rownames(candidates)
candidates <- candidates %>% gather(gene, value, -RNAseqID)  %>% 
  filter(RNAseqID != "gene")
candidates$value <- as.numeric(candidates$value)
candidates$V1  <- candidates$RNAseqID
candidatecounts <- left_join(candidates, colData)
candidatecounts$faketime <- as.numeric(candidatecounts$treatment)
candidatecounts$gene <- as.factor(candidatecounts$gene)


p1 <- candidatecounts %>%
  filter(gene %in% c( "AR", "CYP19A1", "ESR1", "ESR2", "FSHR")) %>%
  ggplot(aes(x = treatment, y = value, fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~gene, scales = "free", nrow = 1) +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom") +
  labs(subtitle = eachgroup)
p1

print(p1)

cat("\n")

p2 <- candidatecounts %>%
  filter(gene %in% c("GHRL", "GAL", "NPVF", "GNRH1", "LHCGR")) %>%
  ggplot(aes(x = treatment, y = value, fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~gene, scales = "free", nrow = 1) +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom") +
  labs(subtitle = eachgroup)
p2

print(p2)

cat("\n")

p3 <- candidatecounts %>%
  filter(gene %in% c("PGR", "PRL", "PRLR", "VIP", "VIPR1")) %>%
  ggplot(aes(x = treatment, y = value, fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~gene, scales = "free", nrow = 1) +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom") +
  labs(subtitle = eachgroup)
p3


print(p3)

cat("\n")

cat("Done with eachgroup")

cat("\n")

}
```

